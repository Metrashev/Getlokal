<?php

/**
 * UnregisteredNewsletterUser
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    getLokal
 * @subpackage model
 * @author     Get Lokal
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class UnregisteredNewsletterUser extends BaseUnregisteredNewsletterUser {
    public function preSave($event) {
        if (!$this->isModified()) return;

        $modifiedFields = $this->getModified();

        if (array_key_exists('email_address', $modifiedFields)) {
            // GetLokal group
            
            $res = Doctrine::getTable('Country')->find($modifiedFields['country_id']);
            if (MC::checkInList($modifiedFields['email_address'], $modifiedFields['country_id'],   sfConfig::get('app_mail_chimp_list_name_' . $res->getSlug())) === false) {
                // Add into MC
                if (MC::onlySubscribe($modifiedFields['email_address'], $modifiedFields['country_id'], $modifiedFields['firstname'], $modifiedFields['lastname'], 'UnregisteredUsers') !== true) {
                    return;
                }
            }
            else {
                $event->skipOperation();

                $ref = '@unregistered_newsletter_user';

                if (sfContext::getInstance()->getRequest()->getReferer()) {
                    //$ref = sfContext::getInstance()->getRequest()->getReferer();
                }

                sfContext::getInstance()->getController()->redirect($ref);
            }
        }
    }

    public function preDelete($event) {
        $country = Doctrine::getTable('Country')->find($this->getCountryId());

        MC::unsubscribe($this->getEmailAddress(), $country->getSlug(), 'UnregisteredUsers');

        return;
    }
}