<?php

/**
 * invitedUser
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    getLokal
 * @subpackage model
 * @author     Get Lokal
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class invitedUser extends BaseinvitedUser
{
    public function getCountInvitedFriends() {
        return Doctrine::getTable('InvitedUser')
                ->createQuery('iu')
                ->addWhere('iu.user_id = ?', $this->getUserId())
                ->addGroupBy('iu.email, iu.facebook_uid')
                ->count();
    }

    public function getCountAcceptedInvites() {
        $query = Doctrine::getTable('InvitedUser')
                ->createQuery('iu')
                //->innerJoin('iu.UserProfile up')
                //->innerJoin('up.sfGuardUser sgu')
                ->addWhere('iu.user_id = ?', $this->getUserId())
                ->addGroupBy('iu.email, iu.facebook_uid');
                //->count();

        $users = array();
        
        foreach ($query->execute() as $user) {
            if ($user->getEmail()) {
                $users['email'][] = $user->getEmail();
            }
            elseif ($user->getFacebookUid()) {
                $users['facebook'][] = $user->getFacebookUid();
            }
        }

        if (count($users)) {
            $cnt1 = $cnt2 = 0;

            if (count($users['email'])) {
                $cnt1 = Doctrine::getTable('SfGuardUser')
                    ->createQuery('sgu')
                    ->whereIn("sgu.email_address", $users['email'])
                    ->count();
            }

            if (count($users['facebook'])) {
                $cnt2 = Doctrine::getTable('UserProfile')
                        ->createQuery('up')
                        ->whereIn('up.facebook_uid', $users['facebook'])
                        ->count();
            }

            return $cnt1 + $cnt2;
        }
        else {
            return 0;
        }
    }

    public function getAcceptedEmailsOrFacebookIds() {
        $query = Doctrine::getTable('InvitedUser')
                ->createQuery('iu')
                //->innerJoin('iu.UserProfile up')
                //->innerJoin('up.sfGuardUser sgu')
                ->addWhere('iu.user_id = ?', $this->getUserId())
                ->addGroupBy('iu.email, iu.facebook_uid');
                //->count();

        $users = array();

        foreach ($query->execute() as $user) {
            if ($user->getEmail()) {
                array_push($users, $user->getEmail());
            }
            elseif ($user->getFacebookUid()) {
                array_push($users, $user->getFacebookUid());
            }
        }

        $tmp = implode(';', $users);

        return $tmp;
    }
}