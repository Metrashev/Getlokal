<?php

/**
 * CompanyImage
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    getLokal
 * @subpackage model
 * @author     Get Lokal
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class CompanyImage extends BaseCompanyImage {

    public function postSave($event) {
        parent::postSave($event);
        $company = $this->getCompany();

        /*
        $photo = Doctrine::getTable('CompanyImage')
                ->createQuery('r')
                ->innerJoin('r.Company c')
                ->innerJoin('r.Image i')
                ->where('i.user_id = ?', $this->getImage()->getUserId())
                ->count();
         */

        $photo = Doctrine::getTable('Image')
                ->createQuery('i')
                ->where('i.user_id = ?', $this->getImage()->getUserId())
                ->count();

        $photo_classification = Doctrine::getTable('CompanyImage')
                ->createQuery('r')
                ->innerJoin('r.Company c')
                ->innerJoin('r.Image i')
                ->where('i.user_id = ?', $this->getImage()->getUserId())
                ->andWhere('c.classification_id = ?', $company->getClassificationId())
                ->count();

        $photo_sector = Doctrine::getTable('CompanyImage')
                ->createQuery('r')
                ->innerJoin('r.Company c')
                ->innerJoin('r.Image i')
                ->where('i.user_id = ?', $this->getImage()->getUserId())
                ->andWhere('c.sector_id = ?', $company->getSectorId())
                ->count();

        Doctrine::getTable('UserStat')->updateStat($this->getImage()->getUserId(), array(
            'photos' => $photo,
            'photo_classification_' . $company->getClassificationId() => $photo_classification,
            'photo_sector_' . $company->getSectorId() => $photo_sector
        ));
		
		if($this->getImage()->getType() == 'video'){
            $query = Doctrine::getTable ( 'Image' )
            ->createQuery ( 'i' )
            ->innerJoin ( 'i.CompanyImage ci' )
            ->where ( 'i.id != ?', $this->getId())
            ->andWhere ( 'ci.company_id = ?', $this->getCompany()->getId())
            ->andWhere('i.type != ?', 'video');
                
            if ($image = $query->fetchOne())
                $company->setImageId($image->getId());
            else
                $company->setImageId(NULL);
        }

        $company->save();
    }

 public function postInsert($event) {
		parent::postInsert ( $event );
		$activity = Doctrine::getTable ( 'ActivityImage' )->getActivity ( $this->getImage()->getId () );
		$activity->setCaption ( $this->getImage()->getCaption () );
		$activity->setUserId ( $this->getImage()->getUserId () );	  
		$activity->setPageId (  $this->getCompany()->getCompanyPage()->getId() );
		$activity->setMediaId ( $this->getImageId () );
		$activity->save ();
	}
}