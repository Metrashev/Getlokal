<?php

/**
 * ListsTable
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ListsTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object ListsTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('Lists');
    }

    static public function applyTitleFilter($query, $value)
    {
        $rootAlias = $query->getRootAlias();
         $query->innerJoin($rootAlias.'.Translation t')
            ->addWhere('t.title like ?', '%'.$value['text'].'%');

        return $query;
    }

    static public function applyFirstNameFilter($query, $value)
    {
        $rootAlias = $query->getRootAlias();
        $query->innerJoin($rootAlias.'.UserProfile u2')
            ->innerJoin('u2.sfGuardUser s2')
            ->addWhere('s2.first_name like ?', $value['text'].'%');
        return $query;
    }

    static public function applyLastNameFilter($query, $value)
    {

        $rootAlias = $query->getRootAlias();
        $query->innerJoin($rootAlias.'.UserProfile l3')
            ->innerJoin('l3.sfGuardUser sg3')
            ->addWhere('sg3.last_name like ?', $value['text'].'%');

        return $query;
    }

    static public function applyCompanyFilter($query, $value)
    {
        $rootAlias = $query->getRootAlias();
        $query->innerJoin($rootAlias.'.ListPage ep4')
            ->innerJoin('ep4.CompanyPage cp4')
            ->innerJoin('cp4.Company c4')
            ->addWhere('c4.title like ? or c4.title_en like ?', array($value['text'].'%', $value['text'].'%'));

        return $query;
    }

    static public function applyCityFilter($query, $value)
    {
        $rootAlias = $query->getRootAlias();
        $query->innerJoin($rootAlias.'.ListPage ep4')
            ->innerJoin('ep4.CompanyPage cp4')
            ->innerJoin('cp4.Company c4')
            ->innerJoin('c4.City c5')
            ->addWhere('c5.id= ? ', $value);

        return $query;
    }

    static public function applyCountryFilter($query, $value)
    {
        $rootAlias = $query->getRootAlias();
         $query->innerJoin($rootAlias.'.ListPage ep4')
            ->innerJoin('ep4.CompanyPage cp4')
            ->innerJoin('cp4.Company c5')
            ->addWhere('c5.country_id = ?',  $value['text'].'%');

        return $query;
    }

    public function getQueryForAdmin(Doctrine_Query $q)
    {
        $rootAlias = $q->getRootAlias();

        $q->innerJoin($rootAlias . '.UserProfile p')
            ->innerJoin($rootAlias.'.ListPage lp')
            ->innerJoin('lp.CompanyPage pp')
            ->innerJoin('pp.Company c')
            ->innerJoin('c.City')
            ->innerJoin('p.sfGuardUser sf')
            ->innerJoin($rootAlias.'.Translation')
            ->where('c.country_id = ?', getlokalPartner::getInstance());

        return $q;
    }

    /**
     * Return autocomplete query
     */
    public static function getAC($query, $culture, $cityId)
    {
        return self::getInstance()->createQuery('l')
            ->innerJoin('l.Translation t')
            ->innerJoin('l.UserProfile up')

            ->where('t.lang = ?', $culture)
            ->andWhere('t.title LIKE ? OR t.description LIKE ?', array($query, $query))
            ->andWhere('up.city_id = ?', $cityId)

            ->andWhere('l.is_active = ?', true)
            ->andWhere('l.is_open = ?', true)
            ->andWhere('l.status = ?', 'approved')

            ->orderBy('l.created_at DESC');
    }
    
    static public function applyCityIdFilter($query, $value)
    {
    	$rootAlias = $query->getRootAlias();
    	$query->addWhere('city_id = ?',  intval($value));
    
    	return $query;
    }

}
