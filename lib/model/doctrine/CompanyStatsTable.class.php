<?php

/**
 * CompanyStatsTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class CompanyStatsTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object CompanyStatsTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('CompanyStats');
    }
static public function saveStatsLog($action_id, $company_id)
  {
  $month = date('Y-m').'-01';
  $stats_log = self::checkNewStatsLog($action_id, $company_id, $month);
  if ($stats_log)
  {
  	$views = $stats_log->getViews();
  	$stats_log->setViews($views+1);
  	$stats_log->save();
  	
  }else {
  	$stats_log = new CompanyStats();
  	$stats_log->setActionId($action_id);
  	$stats_log->setCompanyId($company_id);
  	$stats_log->setMonth($month);
  	$stats_log->save();
  }
  
   

  }

 static public function checkNewStatsLog($action_id, $company_id, $month)
 {
     $stats_log = Doctrine::getTable('CompanyStats')->createQuery('c')
                  ->where('c.action_id = ?', $action_id )
                  ->andWhere('c.company_id = ?', $company_id )
                  ->andWhere('c.month = ?', $month )
                  ->fetchOne();
       if  (count($stats_log) > 0)  
       {
       	return $stats_log;
       }   
       return  false;
 }
 
static public function applyCompanyCityFilter($query, $value)
  {
    $rootAlias = $query->getRootAlias();
      $query->innerJoin($rootAlias.'.Company c4')     
      ->addWhere('c4.city_id = ?',  $value);
      
      return $query;
  }
  
  
  public function getQueryForCompanyStats(Doctrine_Query $q)
  {
  	$rootAlias = $q->getRootAlias();
  
  	$q->innerJoin($rootAlias.'.Company cp6')
  	->addWhere('cp6.country_id = ?',  getlokalPartner::getInstance());
  
  	return $q;
  }
    
  
static public function applyCompanyFilter($query, $value)
  {
  
     $rootAlias = $query->getRootAlias();
    
     $query->innerJoin($rootAlias.'.Company c5')     
      ->addWhere('c5.title like ? or c5.title_en like ?', array($value['text'].'%', $value['text'].'%'));
      
    return $query;
  
  }

  
 static public function applyActionFilter($query, $value)
  {
    $rootAlias = $query->getRootAlias();
   
     $query ->addWhere($rootAlias.'.action_id = ?',  $value['text']);
      
    return $query;
     
   
  }
static public function applyCompanyIdFilter($query, $value)
  {
    $rootAlias = $query->getRootAlias();
   
     $query ->addWhere($rootAlias.'.company_id = ?',  $value['text']);
      
    return $query;
     
   
  }
  
  static public function applyCityIdFilter($query, $value)
  {
  	$rootAlias = $query->getRootAlias();
  	$query->addWhere('company_city = ?',  intval($value));
  
  	return $query;
  }
}
