<?php

/**
 * ReviewTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class ReviewTable extends Doctrine_Table
{
  /**
   * Returns an instance of this class.
   *
   * @return object ReviewTable
   */
  public static function getInstance()
  {
    return Doctrine_Core::getTable('Review');
  }

  public function getQueryForAdmin(Doctrine_Query $q)
  {
    $rootAlias = $q->getRootAlias();

    $q->innerJoin($rootAlias . '.UserProfile p')
      ->leftJoin('p.Image')
      ->innerJoin($rootAlias . '.Company c')
      ->innerJoin('p.sfGuardUser sf')
      ->innerJoin('c.City')
      ->where('c.country_id = ?', sfContext::getInstance()->getUser()->getCountry()->getId());

    return $q;
  }

  public function getTopReview(){

        $this->county = sfContext::getInstance()->getRequest()->getParameter('county', false);    

        $query = self::getInstance()
        ->createQuery('r')
        ->select('r.id, r.text, r.rating, c.id, ct.title, ci.id, cit.id, cit.name, cf.id, cft.id, cft.title, p.id, sf.id, i.*')
        ->innerJoin('r.Company c')
        ->innerJoin('c.Translation ct WITH ct.lang = ?', sfContext::getInstance()->getUser()->getCulture())
        ->innerJoin('c.City ci')
        ->innerJoin('ci.Translation cit WITH cit.lang = ?', sfContext::getInstance()->getUser()->getCulture())
        ->innerJoin('c.Classification cf')
        ->innerJoin('cf.Translation cft')
        ->innerJoin('r.UserProfile p')
        ->innerJoin('p.sfGuardUser sf')
        ->innerJoin('p.Image i')
        ->andWhere('r.parent_id IS NULL')
        ->andWhere('c.status = ?', 0)
//        ->orderBy('r.recommended_at DESC')
        ->orderBy('RAND()')
        ->limit(1);

        if($this->county){
            $query->andWhere('ci.county_id = ?', sfContext::getInstance()->getUser()->getCounty()->getId());
        }else{
          $query->andWhere('c.city_id = ?', sfContext::getInstance()->getUser()->getCity()->getId());
        }

        $review = $query->fetchOne();

        if($review){
          return $review;
        }
        
        return ;
  }

}