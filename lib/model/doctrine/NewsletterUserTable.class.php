<?php

/**
 * NewsletterUserTable
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 */
class NewsletterUserTable extends Doctrine_Table
{
    /**
     * Returns an instance of this class.
     *
     * @return object NewsletterUserTable
     */
    public static function getInstance()
    {
        return Doctrine_Core::getTable('NewsletterUser');
    }
    
    public function getQueryForAdmin(Doctrine_Query $q)
    {
    	$rootAlias = $q->getRootAlias();
    	$q -> innerJoin($rootAlias.'.UserProfile upqa')
    	   -> addWhere('upqa.country_id = ?', getlokalPartner::getInstance());
    
    	return $q;
    }
    
    public static function getPerUserAndNewsletter($user_id,$newsletter_id)
    { 
	$newsletteruser= Doctrine_Core::getTable('NewsletterUser')
    ->createQuery('q')
    ->where('q.user_id = ?', $user_id)
    ->andWhere('q.newsletter_id = ?', $newsletter_id)
    ->fetchOne();
    return $newsletteruser;
    }
  
static public function applyEmailAddressFilter($query, $value)
  {
    $rootAlias = $query->getRootAlias();
    $query->innerJoin($rootAlias.'.UserProfile f1')
            ->innerJoin('f1.sfGuardUser sf1')
            ->addWhere('sf1.email_address like ? ', $value['text'].'%');	

    return $query;
    
  }
  
static public function applyFirstNameFilter($query, $value)
  {
    $rootAlias = $query->getRootAlias();
    $query->innerJoin($rootAlias.'.UserProfile u2')
            ->innerJoin('u2.sfGuardUser s2')
            ->addWhere('s2.first_name like ?', $value['text'].'%');	

    return $query;
       
      
   
  }
  
static public function applyLastNameFilter($query, $value)
  {
  	
    $rootAlias = $query->getRootAlias();
    $query->innerJoin($rootAlias.'.UserProfile l3')
            ->innerJoin('l3.sfGuardUser sg3')
            ->addWhere('sg3.last_name like ?', $value['text'].'%');	

    return $query;
       
      
   
  }
static public function applyUserCityFilter($query, $value)
  {
    $rootAlias = $query->getRootAlias();
      $query->innerJoin($rootAlias.'.UserProfile cp4')  
      ->addWhere('cp4.city_id = ?',  $value);
      
      return $query;
   
  }

  
  static public function applyCountryFilter($query, $value)
  {
    $rootAlias = $query->getRootAlias();
   
     $query->innerJoin($rootAlias.'.UserProfile cp6')     
      ->addWhere('cp6.country_id = ?',  $value['text'].'%');
      
    return $query;
       
      
   
  }
static public function applyIsActiveFilter($query, $value)
  {
    $rootAlias = $query->getRootAlias();
    $query->innerJoin($rootAlias.'.UserProfile up9')
            ->innerJoin('up9.UserSetting sg9')
            ->addWhere($rootAlias.'.is_active= ?' ,$value['text']);	
            if ($value['text'] == 1 ){            
            $query->addWhere('sg9.allow_contact = 1 AND allow_newsletter = 1');	
            }
    return $query; 
   
  }
  
  static public function applyCityIdFilter($query, $value)
  {
  	$rootAlias = $query->getRootAlias();
  	$query->addWhere('user_city = ?',  intval($value));
  
  	return $query;
  }

}